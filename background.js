import { setupContentInjection } from './src/content-injector.js';

var background=function(){"use strict";var Dr=Object.defineProperty;var jr=(q,E,B)=>E in q?Dr(q,E,{enumerable:!0,configurable:!0,writable:!0,value:B}):q[E]=B;var Te=(q,E,B)=>jr(q,typeof E!="symbol"?E+"":E,B);var Me,Oe,Ie,Pe;const E=(Oe=(Me=globalThis.browser)==null?void 0:Me.runtime)!=null&&Oe.id?globalThis.browser:globalThis.chrome;function B(e){return e==null||typeof e=="function"?{main:e}:e}function Lr(e){return e}const ke={extensionInstallUrl:"",extensionUninstallUrl:"",analyticsDomain:"https://eu.convert-webpage-to-pdf.com",analyticsWebsiteId:"d1c33ab3-ea5d-47b5-aa8a-bc64783923d8"};function se(){return ke}async function Se(e,r,t=[],n="ISOLATED"){try{const d=await E.scripting.executeScript({target:{tabId:e},func:r,args:t,world:n});if(E.runtime.lastError)throw E.runtime.lastError;const u=d.at(0);if(!u)throw new Error("No result returned");return u.result}catch(d){throw E.runtime.lastError?E.runtime.lastError:d}}const ae=96,Ce="Emulation.setEmulatedMedia",$e={media:"screen"};async function De(e){const{width:r,height:t}=await Se(e,Fe);return await chrome.debugger.attach({tabId:e},"1.3"),await chrome.debugger.sendCommand({tabId:e},Ce,$e),{width:r,height:t}}const je="Page.printToPDF",Le={printBackground:!0,landscape:!1,marginTop:0,marginBottom:0,marginLeft:0,marginRight:0,scale:1};async function Ne(e,r,t){const{data:n}=await chrome.debugger.sendCommand({tabId:e},je,{...Le,paperWidth:r/ae,paperHeight:t/ae});return n}async function Re(e){await chrome.debugger.detach({tabId:e})}async function Fe(){function e(n){return Math.max(document.documentElement[`client${n}`],document.documentElement[`scroll${n}`],document.documentElement[`offset${n}`],document.body[`scroll${n}`],document.body[`offset${n}`])}const r=e("Width");let t=document.documentElement.scrollHeight||document.body.scrollHeight;const allElements=document.body.getElementsByTagName("*");let maxBottom=0;for(let i=0;i<Math.min(allElements.length,100);i++){const el=allElements[i];if(el.offsetParent!==null){const rect=el.getBoundingClientRect();const bottom=window.scrollY+rect.bottom;if(bottom>maxBottom)maxBottom=bottom}}if(maxBottom>0&&maxBottom<t)t=Math.ceil(maxBottom)+50;return{width:r,height:t}}var ie=Object.prototype.hasOwnProperty;function X(e,r){var t,n;if(e===r)return!0;if(e&&r&&(t=e.constructor)===r.constructor){if(t===Date)return e.getTime()===r.getTime();if(t===RegExp)return e.toString()===r.toString();if(t===Array){if((n=e.length)===r.length)for(;n--&&X(e[n],r[n]););return n===-1}if(!t||typeof e=="object"){n=0;for(t in e)if(ie.call(e,t)&&++n&&!ie.call(r,t)||!(t in r)||!X(e[t],r[t]))return!1;return Object.keys(r).length===n}}return e!==e&&r!==r}const Ve=new Error("request for lock canceled");var Ue=function(e,r,t,n){function d(u){return u instanceof t?u:new t(function(f){f(u)})}return new(t||(t=Promise))(function(u,f){function y(p){try{h(n.next(p))}catch(_){f(_)}}function b(p){try{h(n.throw(p))}catch(_){f(_)}}function h(p){p.done?u(p.value):d(p.value).then(y,b)}h((n=n.apply(e,r||[])).next())})};class qe{constructor(r,t=Ve){this._value=r,this._cancelError=t,this._queue=[],this._weightedWaiters=[]}acquire(r=1,t=0){if(r<=0)throw new Error(`invalid weight ${r}: must be positive`);return new Promise((n,d)=>{const u={resolve:n,reject:d,weight:r,priority:t},f=oe(this._queue,y=>t<=y.priority);f===-1&&r<=this._value?this._dispatchItem(u):this._queue.splice(f+1,0,u)})}runExclusive(r){return Ue(this,arguments,void 0,function*(t,n=1,d=0){const[u,f]=yield this.acquire(n,d);try{return yield t(u)}finally{f()}})}waitForUnlock(r=1,t=0){if(r<=0)throw new Error(`invalid weight ${r}: must be positive`);return this._couldLockImmediately(r,t)?Promise.resolve():new Promise(n=>{this._weightedWaiters[r-1]||(this._weightedWaiters[r-1]=[]),Be(this._weightedWaiters[r-1],{resolve:n,priority:t})})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(r){this._value=r,this._dispatchQueue()}release(r=1){if(r<=0)throw new Error(`invalid weight ${r}: must be positive`);this._value+=r,this._dispatchQueue()}cancel(){this._queue.forEach(r=>r.reject(this._cancelError)),this._queue=[]}_dispatchQueue(){for(this._drainUnlockWaiters();this._queue.length>0&&this._queue[0].weight<=this._value;)this._dispatchItem(this._queue.shift()),this._drainUnlockWaiters()}_dispatchItem(r){const t=this._value;this._value-=r.weight,r.resolve([t,this._newReleaser(r.weight)])}_newReleaser(r){let t=!1;return()=>{t||(t=!0,this.release(r))}}_drainUnlockWaiters(){if(this._queue.length===0)for(let r=this._value;r>0;r--){const t=this._weightedWaiters[r-1];t&&(t.forEach(n=>n.resolve()),this._weightedWaiters[r-1]=[])}else{const r=this._queue[0].priority;for(let t=this._value;t>0;t--){const n=this._weightedWaiters[t-1];if(!n)continue;const d=n.findIndex(u=>u.priority<=r);(d===-1?n:n.splice(0,d)).forEach(u=>u.resolve())}}}_couldLockImmediately(r,t){return(this._queue.length===0||this._queue[0].priority<t)&&r<=this._value}}function Be(e,r){const t=oe(e,n=>r.priority<=n.priority);e.splice(t+1,0,r)}function oe(e,r){for(let t=e.length-1;t>=0;t--)if(r(e[t]))return t;return-1}var Ke=function(e,r,t,n){function d(u){return u instanceof t?u:new t(function(f){f(u)})}return new(t||(t=Promise))(function(u,f){function y(p){try{h(n.next(p))}catch(_){f(_)}}function b(p){try{h(n.throw(p))}catch(_){f(_)}}function h(p){p.done?u(p.value):d(p.value).then(y,b)}h((n=n.apply(e,r||[])).next())})};class We{constructor(r){this._semaphore=new qe(1,r)}acquire(){return Ke(this,arguments,void 0,function*(r=0){const[,t]=yield this._semaphore.acquire(1,r);return t})}runExclusive(r,t=0){return this._semaphore.runExclusive(()=>r(),1,t)}isLocked(){return this._semaphore.isLocked()}waitForUnlock(r=0){return this._semaphore.waitForUnlock(1,r)}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}const W=((Pe=(Ie=globalThis.browser)==null?void 0:Ie.runtime)==null?void 0:Pe.id)==null?globalThis.chrome:globalThis.browser,G=ze();function ze(){const e={local:z("local"),session:z("session"),sync:z("sync"),managed:z("managed")},r=i=>{const s=e[i];if(s==null){const a=Object.keys(e).join(", ");throw Error(`Invalid area "${i}". Options: ${a}`)}return s},t=i=>{const s=i.indexOf(":"),a=i.substring(0,s),o=i.substring(s+1);if(o==null)throw Error(`Storage key should be in the form of "area:key", but received "${i}"`);return{driverArea:a,driverKey:o,driver:r(a)}},n=i=>i+"$",d=(i,s)=>{const a={...i};return Object.entries(s).forEach(([o,g])=>{g==null?delete a[o]:a[o]=g}),a},u=(i,s)=>i??s??null,f=i=>typeof i=="object"&&!Array.isArray(i)?i:{},y=async(i,s,a)=>{const o=await i.getItem(s);return u(o,(a==null?void 0:a.fallback)??(a==null?void 0:a.defaultValue))},b=async(i,s)=>{const a=n(s),o=await i.getItem(a);return f(o)},h=async(i,s,a)=>{await i.setItem(s,a??null)},p=async(i,s,a)=>{const o=n(s),g=f(await i.getItem(o));await i.setItem(o,d(g,a))},_=async(i,s,a)=>{if(await i.removeItem(s),a!=null&&a.removeMeta){const o=n(s);await i.removeItem(o)}},k=async(i,s,a)=>{const o=n(s);if(a==null)await i.removeItem(o);else{const g=f(await i.getItem(o));[a].flat().forEach(w=>delete g[w]),await i.setItem(o,g)}},C=(i,s,a)=>i.watch(s,a);return{getItem:async(i,s)=>{const{driver:a,driverKey:o}=t(i);return await y(a,o,s)},getItems:async i=>{const s=new Map,a=new Map,o=[];i.forEach(w=>{let M,O;typeof w=="string"?M=w:"getValue"in w?(M=w.key,O={fallback:w.fallback}):(M=w.key,O=w.options),o.push(M);const{driverArea:D,driverKey:l}=t(M),c=s.get(D)??[];s.set(D,c.concat(l)),a.set(M,O)});const g=new Map;return await Promise.all(Array.from(s.entries()).map(async([w,M])=>{(await e[w].getItems(M)).forEach(D=>{const l=`${w}:${D.key}`,c=a.get(l),m=u(D.value,(c==null?void 0:c.fallback)??(c==null?void 0:c.defaultValue));g.set(l,m)})})),o.map(w=>({key:w,value:g.get(w)}))},getMeta:async i=>{const{driver:s,driverKey:a}=t(i);return await b(s,a)},getMetas:async i=>{const s=i.map(g=>{const w=typeof g=="string"?g:g.key,{driverArea:M,driverKey:O}=t(w);return{key:w,driverArea:M,driverKey:O,driverMetaKey:n(O)}}),a=s.reduce((g,w)=>{var M;return g[M=w.driverArea]??(g[M]=[]),g[w.driverArea].push(w),g},{}),o={};return await Promise.all(Object.entries(a).map(async([g,w])=>{const M=await W.storage[g].get(w.map(O=>O.driverMetaKey));w.forEach(O=>{o[O.key]=M[O.driverMetaKey]??{}})})),s.map(g=>({key:g.key,meta:o[g.key]}))},setItem:async(i,s)=>{const{driver:a,driverKey:o}=t(i);await h(a,o,s)},setItems:async i=>{const s={};i.forEach(a=>{const{driverArea:o,driverKey:g}=t("key"in a?a.key:a.item.key);s[o]??(s[o]=[]),s[o].push({key:g,value:a.value})}),await Promise.all(Object.entries(s).map(async([a,o])=>{await r(a).setItems(o)}))},setMeta:async(i,s)=>{const{driver:a,driverKey:o}=t(i);await p(a,o,s)},setMetas:async i=>{const s={};i.forEach(a=>{const{driverArea:o,driverKey:g}=t("key"in a?a.key:a.item.key);s[o]??(s[o]=[]),s[o].push({key:g,properties:a.meta})}),await Promise.all(Object.entries(s).map(async([a,o])=>{const g=r(a),w=o.map(({key:l})=>n(l));console.log(a,w);const M=await g.getItems(w),O=Object.fromEntries(M.map(({key:l,value:c})=>[l,f(c)])),D=o.map(({key:l,properties:c})=>{const m=n(l);return{key:m,value:d(O[m]??{},c)}});await g.setItems(D)}))},removeItem:async(i,s)=>{const{driver:a,driverKey:o}=t(i);await _(a,o,s)},removeItems:async i=>{const s={};i.forEach(a=>{let o,g;typeof a=="string"?o=a:"getValue"in a?o=a.key:"item"in a?(o=a.item.key,g=a.options):(o=a.key,g=a.options);const{driverArea:w,driverKey:M}=t(o);s[w]??(s[w]=[]),s[w].push(M),g!=null&&g.removeMeta&&s[w].push(n(M))}),await Promise.all(Object.entries(s).map(async([a,o])=>{await r(a).removeItems(o)}))},clear:async i=>{await r(i).clear()},removeMeta:async(i,s)=>{const{driver:a,driverKey:o}=t(i);await k(a,o,s)},snapshot:async(i,s)=>{var g;const o=await r(i).snapshot();return(g=s==null?void 0:s.excludeKeys)==null||g.forEach(w=>{delete o[w],delete o[n(w)]}),o},restoreSnapshot:async(i,s)=>{await r(i).restoreSnapshot(s)},watch:(i,s)=>{const{driver:a,driverKey:o}=t(i);return C(a,o,s)},unwatch(){Object.values(e).forEach(i=>{i.unwatch()})},defineItem:(i,s)=>{const{driver:a,driverKey:o}=t(i),{version:g=1,migrations:w={}}=s??{};if(g<1)throw Error("Storage item version cannot be less than 1. Initial versions should be set to 1, not 0.");const M=async()=>{var S;const m=n(o),[{value:v},{value:I}]=await a.getItems([o,m]);if(v==null)return;const T=(I==null?void 0:I.v)??1;if(T>g)throw Error(`Version downgrade detected (v${T} -> v${g}) for "${i}"`);if(T===g)return;console.debug(`[@wxt-dev/storage] Running storage migration for ${i}: v${T} -> v${g}`);const $=Array.from({length:g-T},(P,L)=>T+L+1);let x=v;for(const P of $)try{x=await((S=w==null?void 0:w[P])==null?void 0:S.call(w,x))??x}catch(L){throw new Je(i,P,{cause:L})}await a.setItems([{key:o,value:x},{key:m,value:{...I,v:g}}]),console.debug(`[@wxt-dev/storage] Storage migration completed for ${i} v${g}`,{migratedValue:x})},O=(s==null?void 0:s.migrations)==null?Promise.resolve():M().catch(m=>{console.error(`[@wxt-dev/storage] Migration failed for ${i}`,m)}),D=new We,l=()=>(s==null?void 0:s.fallback)??(s==null?void 0:s.defaultValue)??null,c=()=>D.runExclusive(async()=>{const m=await a.getItem(o);if(m!=null||(s==null?void 0:s.init)==null)return m;const v=await s.init();return await a.setItem(o,v),v});return O.then(c),{key:i,get defaultValue(){return l()},get fallback(){return l()},getValue:async()=>(await O,s!=null&&s.init?await c():await y(a,o,s)),getMeta:async()=>(await O,await b(a,o)),setValue:async m=>(await O,await h(a,o,m)),setMeta:async m=>(await O,await p(a,o,m)),removeValue:async m=>(await O,await _(a,o,m)),removeMeta:async m=>(await O,await k(a,o,m)),watch:m=>C(a,o,(v,I)=>m(v??l(),I??l())),migrate:M}}}}function z(e){const r=()=>{if(W.runtime==null)throw Error(["'wxt/storage' must be loaded in a web extension environment",`
 - If thrown during a build, see https://github.com/wxt-dev/wxt/issues/371`,` - If thrown during tests, mock 'wxt/browser' correctly. See https://wxt.dev/guide/go-further/testing.html
`].join(`
`));if(W.storage==null)throw Error("You must add the 'storage' permission to your manifest to use 'wxt/storage'");const n=W.storage[e];if(n==null)throw Error(`"browser.storage.${e}" is undefined`);return n},t=new Set;return{getItem:async n=>(await r().get(n))[n],getItems:async n=>{const d=await r().get(n);return n.map(u=>({key:u,value:d[u]??null}))},setItem:async(n,d)=>{d==null?await r().remove(n):await r().set({[n]:d})},setItems:async n=>{const d=n.reduce((u,{key:f,value:y})=>(u[f]=y,u),{});await r().set(d)},removeItem:async n=>{await r().remove(n)},removeItems:async n=>{await r().remove(n)},clear:async()=>{await r().clear()},snapshot:async()=>await r().get(),restoreSnapshot:async n=>{await r().set(n)},watch(n,d){const u=f=>{const y=f[n];y!=null&&(X(y.newValue,y.oldValue)||d(y.newValue??null,y.oldValue??null))};return r().onChanged.addListener(u),t.add(u),()=>{r().onChanged.removeListener(u),t.delete(u)}},unwatch(){t.forEach(n=>{r().onChanged.removeListener(n)}),t.clear()}}}class Je extends Error{constructor(r,t,n){super(`v${t} migration failed for "${r}"`,n),this.key=r,this.version=t}}const le=3e4,R=G.defineItem("local:progress",{version:1,init:()=>({})});async function ce(){const e=await R.getMeta();if(e)for(const r of Object.values(e))clearTimeout(r==null?void 0:r.timeout);await R.removeValue({removeMeta:!0}),E.action.setBadgeText({text:""})}async function He(e,r){if(r===0)throw new Error("use reset to set 0");const t=[],n=await R.getMeta();if(!n||!n[e]){const d=setTimeout(()=>R.removeMeta([e]),le);t.push(R.setMeta({[e]:{createdAt:Date.now(),timeout:d}})),t.push(E.action.setBadgeText({text:"⬇"}))}t.push(R.setValue({[e]:r})),await Promise.all(t)}async function Ze(){const[e,r]=await Promise.all([R.getValue(),R.getMeta()]);if(!e||!Object.keys(e).length)return!1;if(r){let t=!1;for(const[n,d]of Object.entries(r))if(d&&d.createdAt+le>=Date.now()){t=!0;break}return t?!0:(await ce(),!1)}return!1}async function j(e,r){if(e===null||r===0)return ce();await He(e,r)}const Xe=G.defineItem("local:settings",{init:()=>({patchesOn:!0,prescrollOn:!0,autoSaveOn:!0,analyticsOn:!1,expandScrollableOn:!0,hideFixedOn:!0,filenameStrategy:"title",showStickerOn:!0})});async function ue(){return Xe.getValue()}const ge=G.defineItem("local:total_usage_count",{version:1,fallback:0,init:()=>0});async function Ge(){const r=await ge.getValue()+1;return await ge.setValue(r),r}function V(e,r,t){const{analyticsDomain:n}=se(),d=`${n}/api/klkt`;ue().then(({analyticsOn:u})=>{u&&fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},mode:"cors",body:JSON.stringify({type:"event",payload:{...r,url:"/"+e,data:t}})}).catch(console.log)}).catch(console.log)}const Qe=[EvalError,RangeError,ReferenceError,SyntaxError,TypeError,URIError,globalThis.DOMException,globalThis.AssertionError,globalThis.SystemError].filter(Boolean).map(e=>[e.name,e]),Ye=new Map(Qe);class Q extends Error{constructor(t){super(Q._prepareSuperMessage(t));Te(this,"name","NonError")}static _prepareSuperMessage(t){try{return JSON.stringify(t)}catch{return String(t)}}}const er=[{property:"name",enumerable:!1},{property:"message",enumerable:!1},{property:"stack",enumerable:!1},{property:"code",enumerable:!0},{property:"cause",enumerable:!1}],Y=new WeakSet,rr=e=>{Y.add(e);const r=e.toJSON();return Y.delete(e),r},me=e=>Ye.get(e)??Error,ee=({from:e,seen:r,to:t,forceEnumerable:n,maxDepth:d,depth:u,useToJSON:f,serialize:y})=>{if(!t)if(Array.isArray(e))t=[];else if(!y&&de(e)){const h=me(e.name);t=new h}else t={};if(r.push(e),u>=d)return t;if(f&&typeof e.toJSON=="function"&&!Y.has(e))return rr(e);const b=h=>ee({from:h,seen:[...r],forceEnumerable:n,maxDepth:d,depth:u,useToJSON:f,serialize:y});for(const[h,p]of Object.entries(e)){if(p&&p instanceof Uint8Array&&p.constructor.name==="Buffer"){t[h]="[object Buffer]";continue}if(p!==null&&typeof p=="object"&&typeof p.pipe=="function"){t[h]="[object Stream]";continue}if(typeof p!="function"){if(!p||typeof p!="object"){try{t[h]=p}catch{}continue}if(!r.includes(e[h])){u++,t[h]=b(e[h]);continue}t[h]="[Circular]"}}for(const{property:h,enumerable:p}of er)typeof e[h]<"u"&&e[h]!==null&&Object.defineProperty(t,h,{value:de(e[h])?b(e[h]):e[h],enumerable:n?!0:p,configurable:!0,writable:!0});return t};function tr(e,r={}){const{maxDepth:t=Number.POSITIVE_INFINITY,useToJSON:n=!0}=r;return typeof e=="object"&&e!==null?ee({from:e,seen:[],forceEnumerable:!0,maxDepth:t,depth:0,useToJSON:n,serialize:!0}):typeof e=="function"?`[Function: ${e.name||"anonymous"}]`:e}function nr(e,r={}){const{maxDepth:t=Number.POSITIVE_INFINITY}=r;if(e instanceof Error)return e;if(sr(e)){const n=me(e.name);return ee({from:e,seen:[],to:new n,maxDepth:t,depth:0,serialize:!1})}return new Q(e)}function de(e){return!!e&&typeof e=="object"&&"name"in e&&"message"in e&&"stack"in e}function sr(e){return!!e&&typeof e=="object"&&"message"in e&&!Array.isArray(e)}var ar=Object.defineProperty,ir=Object.defineProperties,or=Object.getOwnPropertyDescriptors,fe=Object.getOwnPropertySymbols,lr=Object.prototype.hasOwnProperty,cr=Object.prototype.propertyIsEnumerable,Ae=(e,r,t)=>r in e?ar(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,he=(e,r)=>{for(var t in r||(r={}))lr.call(r,t)&&Ae(e,t,r[t]);if(fe)for(var t of fe(r))cr.call(r,t)&&Ae(e,t,r[t]);return e},we=(e,r)=>ir(e,or(r)),ur=(e,r,t)=>new Promise((n,d)=>{var u=b=>{try{y(t.next(b))}catch(h){d(h)}},f=b=>{try{y(t.throw(b))}catch(h){d(h)}},y=b=>b.done?n(b.value):Promise.resolve(b.value).then(u,f);y((t=t.apply(e,r)).next())});function gr(e){let r,t={};function n(){Object.entries(t).length===0&&(r==null||r(),r=void 0)}let d=Math.floor(Math.random()*1e4);function u(){return d++}return{sendMessage(f,y,...b){return ur(this,null,function*(){var h,p,_,k;const C={id:u(),type:f,data:y,timestamp:Date.now()},A=(p=yield(h=e.verifyMessageData)==null?void 0:h.call(e,C))!=null?p:C;(_=e.logger)==null||_.debug(`[messaging] sendMessage {id=${A.id}} \u2500\u1405`,A,...b);const i=yield e.sendMessage(A,...b),{res:s,err:a}=i??{err:new Error("No response")};if((k=e.logger)==null||k.debug(`[messaging] sendMessage {id=${A.id}} \u140a\u2500`,{res:s,err:a}),a!=null)throw nr(a);return s})},onMessage(f,y){var b,h,p;if(r==null&&((b=e.logger)==null||b.debug(`[messaging] "${f}" initialized the message listener for this context`),r=e.addRootListener(_=>{var k,C;if(typeof _.type!="string"||typeof _.timestamp!="number"){if(e.breakError)return;const s=Error(`[messaging] Unknown message format, must include the 'type' & 'timestamp' fields, received: ${JSON.stringify(_)}`);throw(k=e.logger)==null||k.error(s),s}(C=e==null?void 0:e.logger)==null||C.debug("[messaging] Received message",_);const A=t[_.type];if(A==null)return;const i=A(_);return Promise.resolve(i).then(s=>{var a,o;return(o=(a=e.verifyMessageData)==null?void 0:a.call(e,s))!=null?o:s}).then(s=>{var a;return(a=e==null?void 0:e.logger)==null||a.debug(`[messaging] onMessage {id=${_.id}} \u2500\u1405`,{res:s}),{res:s}}).catch(s=>{var a;return(a=e==null?void 0:e.logger)==null||a.debug(`[messaging] onMessage {id=${_.id}} \u2500\u1405`,{err:s}),{err:tr(s)}})})),t[f]!=null){const _=Error(`[messaging] In this JS context, only one listener can be setup for ${f}`);throw(h=e.logger)==null||h.error(_),_}return t[f]=y,(p=e.logger)==null||p.log(`[messaging] Added listener for ${f}`),()=>{delete t[f],n()}},removeAllListeners(){Object.keys(t).forEach(f=>{delete t[f]}),n()}}}function mr(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var J={exports:{}},dr=J.exports,ye;function fr(){return ye||(ye=1,function(e,r){(function(t,n){n(e)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:dr,function(t){var n,d;if(!((d=(n=globalThis.chrome)==null?void 0:n.runtime)!=null&&d.id))throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const u="The message port closed before a response was received.",f=y=>{const b={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(b).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class h extends WeakMap{constructor(c,m=void 0){super(m),this.createItem=c}get(c){return this.has(c)||this.set(c,this.createItem(c)),super.get(c)}}const p=l=>l&&typeof l=="object"&&typeof l.then=="function",_=(l,c)=>(...m)=>{y.runtime.lastError?l.reject(new Error(y.runtime.lastError.message)):c.singleCallbackArg||m.length<=1&&c.singleCallbackArg!==!1?l.resolve(m[0]):l.resolve(m)},k=l=>l==1?"argument":"arguments",C=(l,c)=>function(v,...I){if(I.length<c.minArgs)throw new Error(`Expected at least ${c.minArgs} ${k(c.minArgs)} for ${l}(), got ${I.length}`);if(I.length>c.maxArgs)throw new Error(`Expected at most ${c.maxArgs} ${k(c.maxArgs)} for ${l}(), got ${I.length}`);return new Promise((T,$)=>{if(c.fallbackToNoCallback)try{v[l](...I,_({resolve:T,reject:$},c))}catch(x){console.warn(`${l} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,x),v[l](...I),c.fallbackToNoCallback=!1,c.noCallback=!0,T()}else c.noCallback?(v[l](...I),T()):v[l](...I,_({resolve:T,reject:$},c))})},A=(l,c,m)=>new Proxy(c,{apply(v,I,T){return m.call(I,l,...T)}});let i=Function.call.bind(Object.prototype.hasOwnProperty);const s=(l,c={},m={})=>{let v=Object.create(null),I={has($,x){return x in l||x in v},get($,x,S){if(x in v)return v[x];if(!(x in l))return;let P=l[x];if(typeof P=="function")if(typeof c[x]=="function")P=A(l,l[x],c[x]);else if(i(m,x)){let L=C(x,m[x]);P=A(l,l[x],L)}else P=P.bind(l);else if(typeof P=="object"&&P!==null&&(i(c,x)||i(m,x)))P=s(P,c[x],m[x]);else if(i(m,"*"))P=s(P,c[x],m["*"]);else return Object.defineProperty(v,x,{configurable:!0,enumerable:!0,get(){return l[x]},set(L){l[x]=L}}),P;return v[x]=P,P},set($,x,S,P){return x in v?v[x]=S:l[x]=S,!0},defineProperty($,x,S){return Reflect.defineProperty(v,x,S)},deleteProperty($,x){return Reflect.deleteProperty(v,x)}},T=Object.create(l);return new Proxy(T,I)},a=l=>({addListener(c,m,...v){c.addListener(l.get(m),...v)},hasListener(c,m){return c.hasListener(l.get(m))},removeListener(c,m){c.removeListener(l.get(m))}}),o=new h(l=>typeof l!="function"?l:function(m){const v=s(m,{},{getContent:{minArgs:0,maxArgs:0}});l(v)}),g=new h(l=>typeof l!="function"?l:function(m,v,I){let T=!1,$,x=new Promise(K=>{$=function(N){T=!0,K(N)}}),S;try{S=l(m,v,$)}catch(K){S=Promise.reject(K)}const P=S!==!0&&p(S);if(S!==!0&&!P&&!T)return!1;const L=K=>{K.then(N=>{I(N)},N=>{let ne;N&&(N instanceof Error||typeof N.message=="string")?ne=N.message:ne="An unexpected error occurred",I({__mozWebExtensionPolyfillReject__:!0,message:ne})}).catch(N=>{console.error("Failed to send onMessage rejected reply",N)})};return L(P?S:x),!0}),w=({reject:l,resolve:c},m)=>{y.runtime.lastError?y.runtime.lastError.message===u?c():l(new Error(y.runtime.lastError.message)):m&&m.__mozWebExtensionPolyfillReject__?l(new Error(m.message)):c(m)},M=(l,c,m,...v)=>{if(v.length<c.minArgs)throw new Error(`Expected at least ${c.minArgs} ${k(c.minArgs)} for ${l}(), got ${v.length}`);if(v.length>c.maxArgs)throw new Error(`Expected at most ${c.maxArgs} ${k(c.maxArgs)} for ${l}(), got ${v.length}`);return new Promise((I,T)=>{const $=w.bind(null,{resolve:I,reject:T});v.push($),m.sendMessage(...v)})},O={devtools:{network:{onRequestFinished:a(o)}},runtime:{onMessage:a(g),onMessageExternal:a(g),sendMessage:M.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:M.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},D={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return b.privacy={network:{"*":D},services:{"*":D},websites:{"*":D}},s(y,O,b)};t.exports=f(chrome)}else t.exports=globalThis.browser})}(J)),J.exports}var Ar=fr();const H=mr(Ar);function hr(e){return gr(we(he({},e),{sendMessage(r,t){if(t==null)return H.runtime.sendMessage(r);const n=typeof t=="number"?{tabId:t}:t;return H.tabs.sendMessage(n.tabId,r,n.frameId!=null?{frameId:n.frameId}:void 0)},addRootListener(r){const t=(n,d)=>r(typeof n=="object"?we(he({},n),{sender:d}):n);return H.runtime.onMessage.addListener(t),()=>H.runtime.onMessage.removeListener(t)}}))}function U(e){return"result"in e}function pe(e){return{result:e}}const{sendMessage:wr,onMessage:xe}=hr();async function F(...e){return ve(!0,["content-scripts/content.js"],"ISOLATED",...e)}async function ve(e,r,t,...n){try{return await wr(...n)}catch(d){if(d instanceof Error&&d.message.includes("Could not establish connection")&&e){if(typeof n[2]!="number")throw new Error("Invalid tabId for retry, origianl error: "+d.message);try{if(await E.scripting.executeScript({target:{tabId:n[2]},files:r,world:t}),E.runtime.lastError)throw E.runtime.lastError}catch(u){throw E.runtime.lastError?E.runtime.lastError:u}return ve(!1,r,t,...n)}else throw d}}const yr=3e4;async function be(e){async function r(A,i){A&&i?(console.error(A,i,{tabId:e}),V("error",f,{step:A,error:String(i),...u})):V("success",f,{duration:Tr(d),...u}),await j(n,0).catch(console.error)}const t=await Pr(e);if(!t)return;const n=t.url,d=Date.now();let u={};const[f,y]=await Promise.all([pr(e),ue()]);if(V("start",f),await Ze())return V("prevent_concurrent",f);await j(n,10);const b={width:0,height:0};try{const A=await De(e);b.width=A.width,b.height=A.height,await j(n,20)}catch(A){return await r("0",A)}let h=null;try{if(y.prescrollOn&&(h=await xr(e)),y.patchesOn){const A=await br(e,y);b.width=A.width,b.height=A.height}await j(n,30),y.prescrollOn&&await re(700)}catch(A){return await r("1",A)}let p;try{p=await Ne(e,b.width,b.height),await j(n,40)}catch(A){return await r("2",A)}try{y.patchesOn&&await Er(e),y.prescrollOn&&h&&await vr(e,h),await j(n,50)}catch(A){return await r("3",A)}try{await Re(e),await j(n,60)}catch(A){return await r("4",A)}let _;try{const A=await _r(e,p);_=A.result,u={...u,...A.meta},await j(n,70)}catch(A){return await r("5",A)}let k;try{k=await Mr(e),await j(n,80)}catch(A){return await r("6",A)}V("processed",f,u);let C;try{C=await E.downloads.download({url:_,filename:k+".pdf",conflictAction:y.autoSaveOn?"uniquify":"prompt",saveAs:!y.autoSaveOn})}catch(A){return await r("7",A)}V("download_started",f,u);try{let A=!1;const i=Date.now();for(;Date.now()<i+yr;){const s=await Or(C);if(s===-1)return await r("8","interrupted");if(s===1){await Ge(),await j(n,100),await re(100),A=!0;break}await j(n,90+10*s),await re(100)}if(!A)throw new Error("download_timeout")}catch(A){return await r("8",A)}try{await Ir(C,e)}catch(A){return await r("9",A)}await r()}async function pr(e){const r=await F("getBrowserInfo",void 0,e);if(!U(r))throw new Error(r.error);return r.result}async function xr(e){const r=await F("prescroll",void 0,e);if(!U(r))throw new Error(r.error);return r.result}async function vr(e,r){const t=await F("postscroll",r,e);if(!U(t))throw new Error(t.error)}async function br(e,r){const t=await F("applyPatches",r,e);if(!U(t))throw new Error(t.error);return t.result}async function Er(e){const r=await F("revertPatches",void 0,e);if(!U(r))throw new Error(r.error)}async function _r(e,r){const t=await F("scaleAndSplitPdf",r,e);if(!U(t))throw new Error(t.error);return t.result}async function Mr(e){const r=await F("getName",void 0,e);if(!U(r))throw new Error(r.error);return r.result}async function Or(e){let r=await E.downloads.search({id:e});if(Array.isArray(r)&&(r=r.at(0)),!r)throw new Error("Could not get download item");switch(r.state){case"interrupted":return-1;case"complete":return 1;case"in_progress":return r.bytesReceived/r.totalBytes-.01;default:throw r.state,new Error("Unknown download state")}}async function Ir(e,r){let t=await E.downloads.search({id:e});if(Array.isArray(t)&&(t=t.at(0)),!t)throw new Error("Could not get download item");}function re(e){return new Promise(r=>setTimeout(r,e))}async function Pr(e){const r=await E.tabs.get(e);return!r||typeof r.url!="string"?null:r}function Tr(e){return Math.round((Date.now()-e)/1e3)+"s"}function kr(){xe("sendEvent",async e=>(V(e.data.name,e.data.browserInfo,e.data.data),pe(null))),xe("openOptionsPage",async()=>(E.runtime.openOptionsPage(),pe(null)))}const Ee="convertWebpageToPdf",Sr=chrome.i18n.getMessage('context_convert_page') || 'Convert page to PDF', Cr=B({persistent:!0,main(){const{extensionInstallUrl:e,extensionUninstallUrl:r}=se();E.contextMenus.onClicked.addListener(async(t,n)=>{_e(n)&&t.menuItemId===Ee&&await be(n.id)}),E.action.onClicked.addListener(async t=>{_e(t)&&await be(t.id)}),E.runtime.onInstalled.addListener(t=>{E.contextMenus.create({id:Ee,title:Sr,contexts:["all"]}),t.reason==="install"&&(E.tabs.create({url:e}),E.runtime.setUninstallURL(r)),j(null,0)}),kr()}});function _e(e){return!!e&&typeof e.id=="number"&&e.id!==-1&&!!e.url&&e.url.startsWith("http")&&!e.url.includes("chromewebstore.google.com")&&!e.discarded}function Nr(){}function Z(e,...r){}const $r={debug:(...e)=>Z(console.debug,...e),log:(...e)=>Z(console.log,...e),warn:(...e)=>Z(console.warn,...e),error:(...e)=>Z(console.error,...e)};let te;try{te=Cr.main(),te instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw $r.error("The background crashed on startup!"),e}return te}();
background;

// 设置内容脚本注入
chrome.runtime.onInstalled.addListener(details => {
  setupContentInjection();
});
